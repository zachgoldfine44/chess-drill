<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ôî Opening Trainer</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0d0a; overflow-x: hidden; }
  .flex { display:flex; } .flex-col { flex-direction:column; } .items-center { align-items:center; }
  .justify-center { justify-content:center; } .justify-between { justify-content:space-between; }
  .gap-1\.5 { gap:6px; } .gap-2 { gap:8px; } .gap-3 { gap:12px; } .gap-4 { gap:16px; }
  .w-full { width:100%; } .max-w-xl { max-width:36rem; } .mx-auto { margin-left:auto; margin-right:auto; }
  .text-center { text-align:center; } .text-lg { font-size:1.125rem; } .text-sm { font-size:0.875rem; }
  .font-bold { font-weight:700; } .font-semibold { font-weight:600; }
  .relative { position:relative; } .absolute { position:absolute; } .inset-0 { top:0;right:0;bottom:0;left:0; }
  .rounded-lg { border-radius:0.5rem; } .rounded-xl { border-radius:0.75rem; }
  .overflow-hidden { overflow:hidden; } .flex-wrap { flex-wrap:wrap; }
  .px-1 { padding-left:0.25rem; padding-right:0.25rem; }
  .px-3 { padding-left:0.75rem; padding-right:0.75rem; }
  .py-1\.5 { padding-top:0.375rem; padding-bottom:0.375rem; }
  .mt-2 { margin-top:0.5rem; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;

const P = { K:"‚ôî",Q:"‚ôï",R:"‚ôñ",B:"‚ôó",N:"‚ôò",P:"‚ôô",k:"‚ôö",q:"‚ôõ",r:"‚ôú",b:"‚ôù",n:"‚ôû",p:"‚ôü" };
const INIT_BOARD = () => [
  ["r","n","b","q","k","b","n","r"],["p","p","p","p","p","p","p","p"],
  [null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],
  [null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],
  ["P","P","P","P","P","P","P","P"],["R","N","B","Q","K","B","N","R"],
];
const sq = s => [8-parseInt(s[1]), s.charCodeAt(0)-97];
const toAlg = (r,c) => String.fromCharCode(97+c) + (8-r);
const applyMove = (board, from, to, extra) => {
  const b = board.map(r=>[...r]);
  const [fr,fc]=sq(from),[tr,tc]=sq(to);
  b[tr][tc]=b[fr][fc]; b[fr][fc]=null;
  if(extra?.castle){const[rfr,rfc]=sq(extra.rookFrom),[rtr,rtc]=sq(extra.rookTo);b[rtr][rtc]=b[rfr][rfc];b[rfr][rfc]=null;}
  if(extra?.enPassant){const[epr,epc]=sq(extra.enPassant);b[epr][epc]=null;}
  return b;
};
const OPENINGS = [
  {
    id:"scotch-classical", name:"Scotch: Classical", eco:"C45", color:"white", category:"Scotch",
    description:"The main line with 4...Bc5. Active piece play + central control via Be3, c3, Bc4.",
    tip:"Be3 controls the a7-d4 diagonal. c3 rebuilds the center. Bc4 develops with tempo on f7.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"d2",to:"d4",san:"d4"},{from:"e5",to:"d4",san:"exd4"},
      {from:"f3",to:"d4",san:"Nxd4"},{from:"f8",to:"c5",san:"Bc5"},
      {from:"c1",to:"e3",san:"Be3"},{from:"d8",to:"f6",san:"Qf6"},
      {from:"c2",to:"c3",san:"c3"},{from:"g8",to:"e7",san:"Nge7"},
      {from:"f1",to:"c4",san:"Bc4"},{from:"d7",to:"d6",san:"d6"},
    ],
    mistakes:[
      {atIndex:7,wrongMove:{from:"d8",to:"h4",san:"Qh4"},punishment:{from:"d4",to:"b5",san:"Nb5"},hint:"Qh4 is greedy ‚Äî Nb5! threatens Nc7+ forking king and rook"},
      {atIndex:9,wrongMove:{from:"g8",to:"h6",san:"Nh6"},punishment:{from:"d4",to:"c6",san:"Nxc6"},hint:"Nh6 is offside ‚Äî Nxc6! You're way ahead in development"},
    ],
  },
  {
    id:"scotch-nxc6", name:"Scotch: Nxc6 System", eco:"C45", color:"white", category:"Scotch",
    description:"After 4...Nf6 5.Nxc6 bxc6, choose: e5 (Schmidt, aggressive) or Bd3 (Mieses, positional).",
    tip:"At the branch: e5 pushes aggressively displacing the knight. Bd3 aims for a calm development edge. Learn both!",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"d2",to:"d4",san:"d4"},{from:"e5",to:"d4",san:"exd4"},
      {from:"f3",to:"d4",san:"Nxd4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"d4",to:"c6",san:"Nxc6"},{from:"b7",to:"c6",san:"bxc6"},
    ],
    branchAt:10,
    branches:[
      {name:"Schmidt (e5)",tip:"e5 displaces the knight. Qe2 supports. c4 clamps d5.",
       continuation:[
        {from:"e4",to:"e5",san:"e5"},{from:"d8",to:"e7",san:"Qe7"},
        {from:"d1",to:"e2",san:"Qe2"},{from:"f6",to:"d5",san:"Nd5"},
        {from:"c2",to:"c4",san:"c4"},{from:"d5",to:"b6",san:"Nb6"},
      ]},
      {name:"Mieses (Bd3)",tip:"Bd3 develops calmly. d5 exd5 cxd5 gives a clean IQP position.",
       continuation:[
        {from:"f1",to:"d3",san:"Bd3"},{from:"d7",to:"d5",san:"d5"},
        {from:"e4",to:"d5",san:"exd5"},{from:"c6",to:"d5",san:"cxd5"},
        {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
        {from:"f8",to:"d6",san:"Bd6"},
      ]},
    ],
    mistakes:[
      {atIndex:3,wrongMove:{from:"f8",to:"c5",san:"Bc5"},punishment:{from:"f3",to:"e5",san:"Nxe5"},hint:"Bc5 doesn't protect e5 ‚Äî Nxe5! grabs a free pawn"},
      {atIndex:7,wrongMove:{from:"d7",to:"d6",san:"d6"},punishment:{from:"d4",to:"f5",san:"Nf5"},hint:"d6 is passive ‚Äî Nf5! grabs a dominant outpost attacking g7 and e7"},
    ],
  },
  {
    id:"vs-sicilian-alapin", name:"vs Sicilian: Alapin", eco:"B22", color:"white", category:"Anti-Sicilian",
    description:"2.c3 avoids heavy Sicilian theory. Aim for a strong d4 center.",
    tip:"After exd5 Qxd5 d4, you have the ideal center. Nf3, Bd3, O-O.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"c7",to:"c5",san:"c5"},
      {from:"c2",to:"c3",san:"c3"},{from:"d7",to:"d5",san:"d5"},
      {from:"e4",to:"d5",san:"exd5"},{from:"d8",to:"d5",san:"Qxd5"},
      {from:"d2",to:"d4",san:"d4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"e7",to:"e6",san:"e6"},
      {from:"f1",to:"d3",san:"Bd3"},{from:"f8",to:"e7",san:"Be7"},
    ],
    mistakes:[
      {atIndex:3,wrongMove:{from:"e7",to:"e6",san:"e6"},punishment:{from:"d2",to:"d4",san:"d4"},hint:"e6 without d5 first is passive ‚Äî d4! seizes a huge center"},
      {atIndex:7,wrongMove:{from:"c5",to:"d4",san:"cxd4"},punishment:{from:"c3",to:"d4",san:"cxd4"},hint:"cxd4 helps you! cxd4 gives the perfect center and Black's queen is exposed"},
    ],
  },
  {
    id:"vs-french-advance", name:"vs French: Advance", eco:"C02", color:"white", category:"Anti-French",
    description:"3.e5 grabs space. Black's light-squared bishop is locked in.",
    tip:"c3 supports d4. After Nc6 Nf3 Qb6, Be2 keeps things solid.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e6",san:"e6"},
      {from:"d2",to:"d4",san:"d4"},{from:"d7",to:"d5",san:"d5"},
      {from:"e4",to:"e5",san:"e5"},{from:"c7",to:"c5",san:"c5"},
      {from:"c2",to:"c3",san:"c3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"d8",to:"b6",san:"Qb6"},
      {from:"f1",to:"e2",san:"Be2"},{from:"g8",to:"e7",san:"Nge7"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"f7",to:"f6",san:"f6"},punishment:{from:"f1",to:"d3",san:"Bd3"},hint:"f6 weakens kingside ‚Äî develop freely with Bd3"},
      {atIndex:7,wrongMove:{from:"c5",to:"d4",san:"cxd4"},punishment:{from:"c3",to:"d4",san:"cxd4"},hint:"cxd4 cxd4 ‚Äî you keep a massive space advantage with the ideal d4+e5 center"},
    ],
  },
  {
    id:"vs-carokann-advance", name:"vs Caro-Kann: Advance", eco:"B12", color:"white", category:"Anti-CK",
    description:"3.e5 gains space. Black's Bf5 is active ‚Äî the tradeoff.",
    tip:"Nf3, Be2, O-O. h4 is a common plan for kingside space.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"c7",to:"c6",san:"c6"},
      {from:"d2",to:"d4",san:"d4"},{from:"d7",to:"d5",san:"d5"},
      {from:"e4",to:"e5",san:"e5"},{from:"c8",to:"f5",san:"Bf5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"e7",to:"e6",san:"e6"},
      {from:"f1",to:"e2",san:"Be2"},{from:"b8",to:"d7",san:"Nd7"},
      {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
      {from:"c6",to:"c5",san:"c5"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"e7",to:"e5",san:"e5"},punishment:{from:"d4",to:"e5",san:"dxe5"},hint:"e5 drops a pawn! dxe5 wins material"},
      {atIndex:7,wrongMove:{from:"h7",to:"h5",san:"h5"},punishment:{from:"f1",to:"d3",san:"Bd3"},hint:"h5 wastes time ‚Äî Bd3! challenges the bishop, Bxd3 Qxd3 with a lead in development"},
    ],
  },
  {
    id:"vs-scandinavian", name:"vs Scandinavian", eco:"B01", color:"white", category:"Anti-Scandi",
    description:"Capture and develop. Black's early queen gets chased ‚Äî free tempi.",
    tip:"Every queen-chase move gains a tempo. Nc3+d4 builds a classical center.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"d7",to:"d5",san:"d5"},
      {from:"e4",to:"d5",san:"exd5"},{from:"d8",to:"d5",san:"Qxd5"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"d5",to:"a5",san:"Qa5"},
      {from:"d2",to:"d4",san:"d4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"c8",to:"f5",san:"Bf5"},
      {from:"f1",to:"d3",san:"Bd3"},{from:"f5",to:"d3",san:"Bxd3"},
      {from:"d1",to:"d3",san:"Qxd3"},{from:"c7",to:"c6",san:"c6"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"d5",to:"d8",san:"Qd8"},punishment:{from:"d2",to:"d4",san:"d4"},hint:"Queen retreats ‚Äî d4! Perfect center AND a development lead"},
      {atIndex:7,wrongMove:{from:"e7",to:"e5",san:"e5"},punishment:{from:"d4",to:"d5",san:"d5"},hint:"e5 is misguided ‚Äî d5! gains space and Black's queen on a5 runs out of squares"},
    ],
  },
  {
    id:"vs-petrov", name:"vs Petrov Defense", eco:"C42", color:"white", category:"Anti-Petrov",
    description:"3.Nxe5 grabs e5. After d6 Nf3 Nxe4, 5.d4 seizes the center.",
    tip:"3.Nxe5 is the main line. d6 Nf3 Nxe4 d4 gives a commanding center. Bd3, O-O, Re1.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"f3",to:"e5",san:"Nxe5"},{from:"d7",to:"d6",san:"d6"},
      {from:"e5",to:"f3",san:"Nf3"},{from:"f6",to:"e4",san:"Nxe4"},
      {from:"d2",to:"d4",san:"d4"},{from:"d6",to:"d5",san:"d5"},
      {from:"f1",to:"d3",san:"Bd3"},{from:"f8",to:"e7",san:"Be7"},
      {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
      {from:"b8",to:"c6",san:"Nc6"},
      {from:"f1",to:"e1",san:"Re1"},{from:"c8",to:"g4",san:"Bg4"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"b8",to:"c6",san:"Nc6"},punishment:{from:"d2",to:"d4",san:"d4"},hint:"Nc6 instead of d6? d4! keeps the extra pawn with a great center"},
      {atIndex:7,wrongMove:{from:"f8",to:"e7",san:"Be7"},punishment:{from:"d2",to:"d4",san:"d4"},hint:"Be7 forgets to grab e4 ‚Äî d4! massive center, you're a pawn up with initiative"},
    ],
  },
  {
    id:"vs-philidor", name:"vs Philidor Defense", eco:"C41", color:"white", category:"Anti-Philidor",
    description:"3.d4 claims the center. Black is solid but passive ‚Äî you get space.",
    tip:"d4 Nf6 Nc3 gives the ideal center. Bc4 targets f7. Re1 presses.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"d7",to:"d6",san:"d6"},
      {from:"d2",to:"d4",san:"d4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"b8",to:"d7",san:"Nbd7"},
      {from:"f1",to:"c4",san:"Bc4"},{from:"f8",to:"e7",san:"Be7"},
      {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
      {from:"e8",to:"g8",san:"O-O",extra:{castle:true,rookFrom:"h8",rookTo:"f8"}},
      {from:"f1",to:"e1",san:"Re1"},{from:"c7",to:"c6",san:"c6"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"c8",to:"g4",san:"Bg4"},punishment:{from:"d4",to:"e5",san:"dxe5"},hint:"Bg4 before developing? dxe5! opens the center while Black is behind"},
      {atIndex:7,wrongMove:{from:"e5",to:"d4",san:"exd4"},punishment:{from:"f3",to:"d4",san:"Nxd4"},hint:"exd4 opens the position for you ‚Äî Nxd4! dominant knight and e4 is a powerhouse"},
    ],
  },
  {
    id:"vs-pirc", name:"vs Pirc/Modern", eco:"B07", color:"white", category:"Anti-Pirc",
    description:"Big center d4+e4+Nc3. Be3+Qd2 prepares aggressive O-O-O.",
    tip:"Be3+Qd2 sets up O-O-O. Then f3+g4 for a kingside pawn storm!",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"d7",to:"d6",san:"d6"},
      {from:"d2",to:"d4",san:"d4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"g7",to:"g6",san:"g6"},
      {from:"c1",to:"e3",san:"Be3"},{from:"f8",to:"g7",san:"Bg7"},
      {from:"d1",to:"d2",san:"Qd2"},{from:"e8",to:"g8",san:"O-O",extra:{castle:true,rookFrom:"h8",rookTo:"f8"}},
      {from:"e1",to:"c1",san:"O-O-O",extra:{castle:true,rookFrom:"a1",rookTo:"d1"}},
      {from:"b8",to:"c6",san:"Nc6"},
      {from:"f2",to:"f3",san:"f3"},{from:"a7",to:"a6",san:"a6"},
    ],
    mistakes:[
      {atIndex:5,wrongMove:{from:"e7",to:"e5",san:"e5"},punishment:{from:"d4",to:"e5",san:"dxe5"},hint:"e5 too early! dxe5 dxe5 Qxd8+ loses castling"},
      {atIndex:7,wrongMove:{from:"b7",to:"b5",san:"b5"},punishment:{from:"e4",to:"e5",san:"e5"},hint:"b5 ignores development ‚Äî e5! attacks the knight and blows open the center"},
    ],
  },
  
  {
    id:"black-vs-italian", name:"vs Italian Game", eco:"C54", color:"black", category:"1.e4 e5",
    description:"Bc5 for the Giuoco Piano. After c3 Nf6 d4, Bb4+ disrupts White.",
    tip:"After d4 exd4 cxd4, Bb4+ disrupts coordination and gains time to castle.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"f1",to:"c4",san:"Bc4"},{from:"f8",to:"c5",san:"Bc5"},
      {from:"c2",to:"c3",san:"c3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"d2",to:"d4",san:"d4"},{from:"e5",to:"d4",san:"exd4"},
      {from:"c3",to:"d4",san:"cxd4"},{from:"c5",to:"b4",san:"Bb4+"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"f6",to:"e4",san:"Nxe4"},
    ],
    mistakes:[
      {atIndex:6,wrongMove:{from:"g1",to:"g5",san:"Ng5"},punishment:{from:"d7",to:"d5",san:"d5"},hint:"Ng5 is the Fried Liver ‚Äî d5! counter-strikes and refutes it"},
      {atIndex:8,wrongMove:{from:"d2",to:"d3",san:"d3"},punishment:{from:"d7",to:"d5",san:"d5"},hint:"d3 is too passive ‚Äî d5! blows open the center"},
    ],
  },
  {
    id:"black-vs-ruylopez", name:"vs Ruy Lopez (Closed)", eco:"C84", color:"black", category:"1.e4 e5",
    description:"Closed Ruy Lopez. a6, Nf6, Be7, b5, O-O ‚Äî rock-solid.",
    tip:"a6 forces the bishop. Ba4 Nf6 attacks e4. b5 Bb3 O-O gives you a fortress.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"f1",to:"b5",san:"Bb5"},{from:"a7",to:"a6",san:"a6"},
      {from:"b5",to:"a4",san:"Ba4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
      {from:"f8",to:"e7",san:"Be7"},
      {from:"f1",to:"e1",san:"Re1"},{from:"b7",to:"b5",san:"b5"},
      {from:"a4",to:"b3",san:"Bb3"},{from:"e8",to:"g8",san:"O-O",extra:{castle:true,rookFrom:"h8",rookTo:"f8"}},
      {from:"c2",to:"c3",san:"c3"},{from:"d7",to:"d6",san:"d6"},
    ],
    mistakes:[
      {atIndex:6,wrongMove:{from:"b5",to:"c6",san:"Bxc6"},punishment:{from:"d7",to:"c6",san:"dxc6"},hint:"Bxc6 Exchange ‚Äî dxc6! bishop pair + open d-file. You're happy!"},
      {atIndex:8,wrongMove:{from:"f3",to:"g5",san:"Ng5"},punishment:{from:"d7",to:"d5",san:"d5"},hint:"Ng5 tries Bxf7+ ‚Äî d5! counter-strikes in the center and refutes it"},
    ],
  },
  {
    id:"black-vs-qgd", name:"vs Queen's Gambit (QGD)", eco:"D37", color:"black", category:"1.d4",
    description:"Rock-solid QGD. d5, e6, Nf6, Be7, castle, then find breaks.",
    tip:"Don't capture c4 ‚Äî d5 pawn is powerful. After castling, aim for c5 or e5 breaks.",
    moves:[
      {from:"d2",to:"d4",san:"d4"},{from:"d7",to:"d5",san:"d5"},
      {from:"c2",to:"c4",san:"c4"},{from:"e7",to:"e6",san:"e6"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"c1",to:"g5",san:"Bg5"},{from:"f8",to:"e7",san:"Be7"},
      {from:"e2",to:"e3",san:"e3"},{from:"e8",to:"g8",san:"O-O",extra:{castle:true,rookFrom:"h8",rookTo:"f8"}},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"d7",san:"Nbd7"},
      {from:"a1",to:"c1",san:"Rc1"},{from:"c7",to:"c6",san:"c6"},
    ],
    mistakes:[
      {atIndex:6,wrongMove:{from:"c4",to:"d5",san:"cxd5"},punishment:{from:"e6",to:"d5",san:"exd5"},hint:"cxd5 releases tension ‚Äî exd5 solid center + easy development"},
      {atIndex:12,wrongMove:{from:"e3",to:"e4",san:"e4"},punishment:{from:"d5",to:"e4",san:"dxe4"},hint:"e4 premature ‚Äî dxe4! wins a pawn, Nxe4 Nxe4 Bxe7 Qxe7 and you're up"},
    ],
  },
  {
    id:"black-vs-london", name:"vs London System", eco:"D02", color:"black", category:"1.d4",
    description:"Against Bf4, challenge with c5 early. Contest the dark squares.",
    tip:"c5 challenges d4. Nc6 and Bd6 contest dark squares. Bxd6 Qxd6 ‚Äî active pieces.",
    moves:[
      {from:"d2",to:"d4",san:"d4"},{from:"d7",to:"d5",san:"d5"},
      {from:"c1",to:"f4",san:"Bf4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"e2",to:"e3",san:"e3"},{from:"c7",to:"c5",san:"c5"},
      {from:"c2",to:"c3",san:"c3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"b1",to:"d2",san:"Nd2"},{from:"e7",to:"e6",san:"e6"},
      {from:"g1",to:"f3",san:"Ngf3"},{from:"f8",to:"d6",san:"Bd6"},
      {from:"f4",to:"d6",san:"Bxd6"},{from:"d8",to:"d6",san:"Qxd6"},
    ],
    mistakes:[
      {atIndex:4,wrongMove:{from:"e2",to:"e4",san:"e4"},punishment:{from:"d5",to:"e4",san:"dxe4"},hint:"e4 overambitious ‚Äî dxe4! wins a pawn, Bf4 blocks the queen"},
      {atIndex:6,wrongMove:{from:"d4",to:"c5",san:"dxc5"},punishment:{from:"e7",to:"e5",san:"e5"},hint:"dxc5 gives up the center ‚Äî e5! attacks the bishop and seizes space"},
    ],
  },
  {
    id:"black-vs-english", name:"vs English (1.c4)", eco:"A20", color:"black", category:"Others",
    description:"1...e5 ‚Äî Reversed Sicilian with an extra tempo.",
    tip:"Nc6 and Nf6 develop naturally. d5 is your key break.",
    moves:[
      {from:"c2",to:"c4",san:"c4"},{from:"e7",to:"e5",san:"e5"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"g2",to:"g3",san:"g3"},{from:"d7",to:"d5",san:"d5"},
      {from:"c4",to:"d5",san:"cxd5"},{from:"f6",to:"d5",san:"Nxd5"},
      {from:"f1",to:"g2",san:"Bg2"},{from:"d5",to:"b6",san:"Nb6"},
    ],
    mistakes:[
      {atIndex:4,wrongMove:{from:"d2",to:"d3",san:"d3"},punishment:{from:"d7",to:"d5",san:"d5"},hint:"d3 is passive ‚Äî d5! strikes the center immediately, cxd5 Nxd5 with great activity"},
      {atIndex:6,wrongMove:{from:"d2",to:"d4",san:"d4"},punishment:{from:"e5",to:"d4",san:"exd4"},hint:"d4 premature ‚Äî exd4! wins a pawn since Nxd4 Bb4 pins and wins"},
    ],
  },
  {
    id:"black-vs-bishops", name:"vs Bishop's Opening", eco:"C24", color:"black", category:"1.e4 e5",
    description:"Against 2.Bc4, play Nf6 to attack e4 right away.",
    tip:"2...Nf6 forces White to defend e4. If Ng5, d5! refutes it.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"f1",to:"c4",san:"Bc4"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"d2",to:"d3",san:"d3"},{from:"f8",to:"c5",san:"Bc5"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"d7",to:"d6",san:"d6"},
      {from:"e1",to:"g1",san:"O-O",extra:{castle:true,rookFrom:"h1",rookTo:"f1"}},
      {from:"e8",to:"g8",san:"O-O",extra:{castle:true,rookFrom:"h8",rookTo:"f8"}},
      {from:"b1",to:"c3",san:"Nc3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"c1",to:"e3",san:"Be3"},{from:"c5",to:"b6",san:"Bb6"},
    ],
    mistakes:[
      {atIndex:4,wrongMove:{from:"g1",to:"g5",san:"Ng5"},punishment:{from:"d7",to:"d5",san:"d5"},hint:"Ng5 trick ‚Äî d5! counter-attacks and wins"},
      {atIndex:8,wrongMove:{from:"c1",to:"g5",san:"Bg5"},punishment:{from:"h7",to:"h6",san:"h6"},hint:"Bg5 before castling ‚Äî h6! wins the bishop pair, Bxf6 Qxf6 and you're better"},
    ],
  },
  {
    id:"black-vs-kgambit", name:"vs King's Gambit", eco:"C30", color:"black", category:"1.e4 e5",
    description:"Falkbeer Counter-Gambit (2...d5) ‚Äî fight back in the center!",
    tip:"After exd5 e4, White's knight is pushed and you develop fast.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"f2",to:"f4",san:"f4"},{from:"d7",to:"d5",san:"d5"},
      {from:"e4",to:"d5",san:"exd5"},{from:"e5",to:"e4",san:"e4"},
      {from:"d2",to:"d3",san:"d3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"d3",to:"e4",san:"dxe4"},{from:"f6",to:"e4",san:"Nxe4"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"f8",to:"c5",san:"Bc5"},
      {from:"d1",to:"e2",san:"Qe2"},{from:"c8",to:"f5",san:"Bf5"},
    ],
    mistakes:[
      {atIndex:4,wrongMove:{from:"f4",to:"e5",san:"fxe5"},punishment:{from:"d5",to:"e4",san:"dxe4"},hint:"fxe5 ignores the center ‚Äî dxe4! grabs a second pawn, White's position collapses"},
      {atIndex:10,wrongMove:{from:"f1",to:"d3",san:"Bd3"},punishment:{from:"e4",to:"f2",san:"Nxf2"},hint:"Bd3 leaves f2 hanging ‚Äî Nxf2! forks king and rook"},
    ],
  },
  {
    id:"black-vs-vienna", name:"vs Vienna Game", eco:"C26", color:"black", category:"1.e4 e5",
    description:"Against 2.Nc3, play Nf6. If d4, exd4 Nxd4 Bb4 ‚Äî active play.",
    tip:"If 3.Bc4, you can play Nxe4! If 3.f4, play d5 ‚Äî same counter-gambit.",
    moves:[
      {from:"e2",to:"e4",san:"e4"},{from:"e7",to:"e5",san:"e5"},
      {from:"b1",to:"c3",san:"Nc3"},{from:"g8",to:"f6",san:"Nf6"},
      {from:"g1",to:"f3",san:"Nf3"},{from:"b8",to:"c6",san:"Nc6"},
      {from:"d2",to:"d4",san:"d4"},{from:"e5",to:"d4",san:"exd4"},
      {from:"f3",to:"d4",san:"Nxd4"},{from:"f8",to:"b4",san:"Bb4"},
      {from:"d4",to:"c6",san:"Nxc6"},{from:"b7",to:"c6",san:"bxc6"},
      {from:"f1",to:"d3",san:"Bd3"},{from:"d7",to:"d5",san:"d5"},
    ],
    mistakes:[
      {atIndex:6,wrongMove:{from:"f1",to:"c4",san:"Bc4"},punishment:{from:"f6",to:"e4",san:"Nxe4"},hint:"Bc4 instead of d4 ‚Äî Nxe4! grabs a free pawn, Nxe4 d5 forks"},
      {atIndex:12,wrongMove:{from:"e4",to:"e5",san:"e5"},punishment:{from:"f6",to:"e4",san:"Ne4"},hint:"e5 pushes without support ‚Äî Ne4! centralized knight dominates"},
    ],
  },
];
const initSR = () => { const d = {}; OPENINGS.forEach(o => { d[o.id] = {box:1,correct:0,incorrect:0,lastDrilled:0,streak:0}; }); return d; };
const boxIntervals = {1:1,2:2,3:4,4:8,5:16};
const boxLabels = {1:"New",2:"Learning",3:"Familiar",4:"Solid",5:"Mastered"};
const boxColors = {
  1:{bg:"#3f1515",border:"#ef4444",text:"#fca5a5",dot:"#f87171"},
  2:{bg:"#3f2415",border:"#f97316",text:"#fdba74",dot:"#fb923c"},
  3:{bg:"#3f3515",border:"#eab308",text:"#fde047",dot:"#facc15"},
  4:{bg:"#153f1f",border:"#22c55e",text:"#86efac",dot:"#4ade80"},
  5:{bg:"#15303f",border:"#06b6d4",text:"#67e8f9",dot:"#22d3ee"},
};
const getNextDrill = (sr, session) => {
  const due = OPENINGS.filter(o => { const s = sr[o.id]; return s && session - s.lastDrilled >= boxIntervals[s.box]; });
  if (!due.length) return OPENINGS.reduce((best, o) => (!best || (sr[o.id]?.box||1) < (sr[best.id]?.box||1)) ? o : best, null);
  due.sort((a, b) => (sr[a.id]?.box||1) - (sr[b.id]?.box||1)); return due[0];
};
const getActiveMoves = (opening, branch) => {
  if (!opening.branchAt) return opening.moves;
  if (branch !== null && opening.branches?.[branch]) return [...opening.moves, ...opening.branches[branch].continuation];
  return opening.moves;
};
const ChessBoard = ({ board, flipped, selected, onSquareClick, lastMove, wrongMove, correctSquare, correctFrom, correctSan, moveAnim }) => {
  const containerRef = useRef(null);
  const [SZ, setSZ] = useState(60);
  useEffect(() => {
    const measure = () => {
      if (containerRef.current) {
        const parentW = containerRef.current.parentElement?.clientWidth || 400;
        const viewportW = window.innerWidth;
        const availW = Math.min(parentW, viewportW - 24, 520);
        const maxSz = Math.floor((availW - 8) / 8);
        setSZ(Math.max(32, Math.min(60, maxSz)));
      }
    };
    measure();
    window.addEventListener('resize', measure);
    return () => window.removeEventListener('resize', measure);
  }, []);
  const rows = flipped ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
  const cols = flipped ? [7,6,5,4,3,2,1,0] : [0,1,2,3,4,5,6,7];
  // Arrow from wrong to correct
  const arrow = useMemo(() => {
    if (!wrongMove || !correctSquare) return null;
    const fx = (flipped ? 7-wrongMove[1] : wrongMove[1]) * SZ + SZ/2;
    const fy = (flipped ? 7-wrongMove[0] : wrongMove[0]) * SZ + SZ/2;
    const tx = (flipped ? 7-correctSquare[1] : correctSquare[1]) * SZ + SZ/2;
    const ty = (flipped ? 7-correctSquare[0] : correctSquare[0]) * SZ + SZ/2;
    return {fx,fy,tx,ty};
  }, [wrongMove, correctSquare, flipped, SZ]);
  return (
    <div ref={containerRef} className="relative" style={{width:SZ*8+6,height:SZ*8+6,maxWidth:"calc(100vw - 24px)",margin:"0 auto"}}>
      {/* Outer frame */}
      <div className="absolute inset-0 rounded-xl" style={{
        background:"linear-gradient(145deg, #8B6914 0%, #5C3D1E 50%, #3A2510 100%)",
        boxShadow:"0 8px 32px rgba(0,0,0,0.6), 0 2px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1)",
        padding:3, borderRadius:14
      }}>
        <div className="rounded-lg overflow-hidden relative" style={{width:SZ*8,height:SZ*8}}>
          {/* Board squares */}
          {rows.map((r,ri) => cols.map((c,ci) => {
            const isLight = (r+c)%2===0;
            const piece = board[r][c];
            const isSel = selected && selected[0]===r && selected[1]===c;
            const isLastFrom = lastMove && lastMove.from[0]===r && lastMove.from[1]===c;
            const isLastTo = lastMove && lastMove.to[0]===r && lastMove.to[1]===c;
            const isWrong = wrongMove && wrongMove[0]===r && wrongMove[1]===c;
            const isCorrect = correctSquare && correctSquare[0]===r && correctSquare[1]===c;
            const isCorrectFrom = correctFrom && correctFrom[0]===r && correctFrom[1]===c;
            // Colors
            const lightSq = "#F0D9B5"; const darkSq = "#B58863";
            const lightHi = "#F7EC7D"; const darkHi = "#DAC34B";
            const selColor = "#7FC8E3";
            let bg = isLight ? lightSq : darkSq;
            if (isLastFrom || isLastTo) bg = isLight ? lightHi : darkHi;
            if (isSel) bg = selColor;
            const x = ci * SZ, y = ri * SZ;
            return (
              <div key={`${r}-${c}`} onClick={() => onSquareClick(r,c)}
                style={{
                  position:"absolute", left:x, top:y, width:SZ, height:SZ,
                  backgroundColor: bg,
                  cursor: "pointer",
                  transition: "background-color 0.12s ease",
                }}>
                {/* Wood grain texture overlay */}
                <div style={{
                  position:"absolute", inset:0, opacity: isLight ? 0.03 : 0.06,
                  background: `repeating-linear-gradient(${isLight?90:85}deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 3px)`,
                  pointerEvents:"none"
                }}/>
                {/* Wrong move indicator ‚Äî red glow */}
                {isWrong && (
                  <div style={{
                    position:"absolute", inset:0,
                    background:"radial-gradient(circle, rgba(239,68,68,0.5) 0%, rgba(239,68,68,0.2) 50%, transparent 70%)",
                    animation:"pulseWrong 0.6s ease-out",
                    pointerEvents:"none", zIndex:5,
                  }}>
                    <div style={{
                      position:"absolute", top:2, left:"50%", transform:"translateX(-50%)",
                      background:"#dc2626", color:"white", fontSize:10, fontWeight:700,
                      padding:"1px 6px", borderRadius:4, whiteSpace:"nowrap",
                      boxShadow:"0 2px 8px rgba(0,0,0,0.4)",
                    }}>‚úï Wrong</div>
                  </div>
                )}
                {/* Correct square indicator ‚Äî green glow + arrow target */}
                {isCorrect && (
                  <div style={{
                    position:"absolute", inset:4,
                    border:"3px solid #22c55e",
                    borderRadius:6,
                    boxShadow:"0 0 12px rgba(34,197,94,0.5), inset 0 0 8px rgba(34,197,94,0.2)",
                    animation:"pulseCorrect 0.8s ease-in-out infinite",
                    pointerEvents:"none", zIndex:5,
                  }}>
                    <div style={{
                      position:"absolute", bottom:-16, left:"50%", transform:"translateX(-50%)",
                      background:"#16a34a", color:"white", fontSize:10, fontWeight:700,
                      padding:"1px 6px", borderRadius:4, whiteSpace:"nowrap",
                      boxShadow:"0 2px 8px rgba(0,0,0,0.4)",
                    }}>{correctSan||"Here ‚Üë"}</div>
                  </div>
                )}
                {/* Correct FROM square indicator */}
                {isCorrectFrom && (
                  <div style={{
                    position:"absolute", inset:4,
                    border:"3px solid #3b82f6",
                    borderRadius:6,
                    boxShadow:"0 0 12px rgba(59,130,246,0.5), inset 0 0 8px rgba(59,130,246,0.2)",
                    animation:"pulseCorrect 0.8s ease-in-out infinite",
                    pointerEvents:"none", zIndex:5,
                  }}>
                    <div style={{
                      position:"absolute", top:-16, left:"50%", transform:"translateX(-50%)",
                      background:"#2563eb", color:"white", fontSize:10, fontWeight:700,
                      padding:"1px 6px", borderRadius:4, whiteSpace:"nowrap",
                      boxShadow:"0 2px 8px rgba(0,0,0,0.4)",
                    }}>This piece</div>
                  </div>
                )}
                {/* Selection indicator ‚Äî ring */}
                {isSel && (
                  <div style={{
                    position:"absolute", inset:3,
                    border:"3px solid rgba(59,130,246,0.7)",
                    borderRadius:"50%",
                    boxShadow:"0 0 12px rgba(59,130,246,0.4)",
                    pointerEvents:"none", zIndex:4,
                  }}/>
                )}
                {/* Piece */}
                {piece && (
                  <div style={{
                    position:"absolute", inset:0, display:"flex", alignItems:"center", justifyContent:"center",
                    fontSize: SZ * 0.72,
                    lineHeight:1,
                    transition: "transform 0.15s ease",
                    transform: isSel ? "scale(1.12)" : "scale(1)",
                    zIndex: isSel ? 10 : 2,
                    filter: piece === piece.toUpperCase()
                      ? "drop-shadow(1px 2px 2px rgba(0,0,0,0.25))"
                      : "drop-shadow(1px 2px 3px rgba(0,0,0,0.45))",
                    userSelect:"none",
                    pointerEvents:"none",
                  }}>{P[piece]}</div>
                )}
                {/* Coordinates */}
                {ci === 0 && (
                  <span style={{
                    position:"absolute", top:2, left:3, fontSize:10, fontWeight:700,
                    color: isLight ? darkSq : lightSq, opacity:0.6, userSelect:"none", pointerEvents:"none",
                    fontFamily:"'Courier New',monospace",
                  }}>{8-r}</span>
                )}
                {ri === 7 && (
                  <span style={{
                    position:"absolute", bottom:1, right:3, fontSize:10, fontWeight:700,
                    color: isLight ? darkSq : lightSq, opacity:0.6, userSelect:"none", pointerEvents:"none",
                    fontFamily:"'Courier New',monospace",
                  }}>{String.fromCharCode(97+c)}</span>
                )}
              </div>
            );
          }))}
          {/* SVG arrow overlay */}
          {arrow && (
            <svg style={{position:"absolute",inset:0,width:SZ*8,height:SZ*8,pointerEvents:"none",zIndex:20}}>
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e" />
                </marker>
              </defs>
              <line x1={arrow.fx} y1={arrow.fy} x2={arrow.tx} y2={arrow.ty}
                stroke="#22c55e" strokeWidth="3" strokeDasharray="6,3"
                markerEnd="url(#arrowhead)" opacity="0.8">
                <animate attributeName="stroke-dashoffset" from="18" to="0" dur="0.8s" repeatCount="indefinite"/>
              </line>
            </svg>
          )}
        </div>
      </div>
      {/* CSS Keyframes */}
      <style>{`
        @keyframes pulseWrong { 0% { opacity:0; transform:scale(0.8); } 30% { opacity:1; transform:scale(1.1); } 100% { opacity:1; transform:scale(1); } }
        @keyframes pulseCorrect { 0%,100% { opacity:0.7; } 50% { opacity:1; } }
        @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
      `}</style>
    </div>
  );
};
const DrillView = ({ opening, sr, setSR, session, onBack }) => {
  const [board,setBoard]=useState(INIT_BOARD());const [moveIndex,setMoveIndex]=useState(0);const [selected,setSelected]=useState(null);
  const [lastMove,setLastMove]=useState(null);const [wrongMove,setWrongMove]=useState(null);const [correctSquare,setCorrectSquare]=useState(null);const [correctFrom,setCorrectFrom]=useState(null);const [correctSan,setCorrectSan]=useState(null);
  const [status,setStatus]=useState("playing");const [moveHistory,setMoveHistory]=useState([]);const [mistakes,setMistakes]=useState(0);
  const [showHint,setShowHint]=useState(false);const [activeBranch,setActiveBranch]=useState(null);const [branchName,setBranchName]=useState(null);
  const timerRef=useRef(null);const isUserWhite=opening.color==="white";
  const activeMoves=useMemo(()=>getActiveMoves(opening,activeBranch),[opening,activeBranch]);
  const isUserTurn=useCallback(idx=>isUserWhite?idx%2===0:idx%2===1,[isUserWhite]);
  useEffect(()=>{setBoard(INIT_BOARD());setMoveIndex(0);setSelected(null);setLastMove(null);setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);setStatus("playing");setMoveHistory([]);setMistakes(0);setShowHint(false);setActiveBranch(null);setBranchName(null);},[opening.id]);
  useEffect(()=>{if(status!=="playing"||moveIndex>=activeMoves.length)return;if(!isUserTurn(moveIndex)){timerRef.current=setTimeout(()=>{const move=activeMoves[moveIndex];setBoard(prev=>applyMove(prev,move.from,move.to,move.extra));setLastMove({from:sq(move.from),to:sq(move.to)});setMoveHistory(prev=>[...prev,move.san]);setMoveIndex(prev=>prev+1);setSelected(null);setShowHint(false);},500);return()=>clearTimeout(timerRef.current);}},[moveIndex,status,activeMoves,isUserTurn]);
  useEffect(()=>{if(moveIndex>=activeMoves.length&&status==="playing"&&(activeBranch!==null||!opening.branchAt)){setStatus("complete");setSR(prev=>{const s={...prev[opening.id]};if(mistakes===0){s.correct++;s.streak++;s.box=Math.min(5,s.box+1);}else{s.incorrect++;s.streak=0;s.box=Math.max(1,s.box-1);}s.lastDrilled=session;return{...prev,[opening.id]:s};});}},[moveIndex,activeMoves,status,mistakes,session,setSR,opening,activeBranch]);
  const handleSquareClick=(r,c)=>{
    if(status!=="playing"||!isUserTurn(moveIndex))return;
    if(wrongMove){setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);}
    if(opening.branchAt!==undefined&&moveIndex===opening.branchAt&&activeBranch===null){
      if(!selected){if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase())setSelected([r,c]);}return;}
      if(selected[0]===r&&selected[1]===c){setSelected(null);return;}
      if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase()){setSelected([r,c]);return;}}
      for(let bi=0;bi<opening.branches.length;bi++){
        const t=opening.branches[bi].continuation[0];const[tfr,tfc]=sq(t.from),[ttr,ttc]=sq(t.to);
        if(selected[0]===tfr&&selected[1]===tfc&&r===ttr&&c===ttc){
          setActiveBranch(bi);setBranchName(opening.branches[bi].name);
          setBoard(prev=>applyMove(prev,t.from,t.to,t.extra));setLastMove({from:[tfr,tfc],to:[ttr,ttc]});
          setMoveHistory(prev=>[...prev,t.san]);setMoveIndex(prev=>prev+1);setSelected(null);setShowHint(false);return;
        }
      }
      setWrongMove([r,c]);setMistakes(prev=>prev+1);setSelected(null);
      setTimeout(()=>{setWrongMove(null);setCorrectSquare(null);},1500);return;
    }
    if(moveIndex>=activeMoves.length)return;
    const em=activeMoves[moveIndex];const[efr,efc]=sq(em.from),[etr,etc]=sq(em.to);
    if(!selected){if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase())setSelected([r,c]);}}
    else{
      if(selected[0]===r&&selected[1]===c){setSelected(null);return;}
      if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase()){setSelected([r,c]);return;}}
      if(selected[0]===efr&&selected[1]===efc&&r===etr&&c===etc){
        setBoard(prev=>applyMove(prev,em.from,em.to,em.extra));setLastMove({from:[efr,efc],to:[etr,etc]});
        setMoveHistory(prev=>[...prev,em.san]);setMoveIndex(prev=>prev+1);setSelected(null);setShowHint(false);
      }else{setWrongMove([r,c]);setCorrectSquare([etr,etc]);setCorrectFrom([efr,efc]);setCorrectSan(em.san);setMistakes(prev=>prev+1);setSelected(null);setTimeout(()=>{setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);},2000);}
    }
  };
  const handleRestart=()=>{setBoard(INIT_BOARD());setMoveIndex(0);setSelected(null);setLastMove(null);setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);setStatus("playing");setMoveHistory([]);setMistakes(0);setShowHint(false);setActiveBranch(null);setBranchName(null);};
  const hint=()=>{if(moveIndex<activeMoves.length&&isUserTurn(moveIndex)){setShowHint(true);setMistakes(prev=>prev+1);}};
  const currentExpected=moveIndex<activeMoves.length&&isUserTurn(moveIndex)?activeMoves[moveIndex]:null;
  const srData=sr[opening.id]||{box:1};const bc=boxColors[srData.box];const currentTip=branchName?opening.branches[activeBranch]?.tip||opening.tip:opening.tip;
  const fmtH=[];for(let i=0;i<moveHistory.length;i+=2)fmtH.push(`${Math.floor(i/2)+1}. ${moveHistory[i]}${moveHistory[i+1]?" "+moveHistory[i+1]:""}`);
  return(
    <div className="flex flex-col items-center gap-4 w-full max-w-xl mx-auto" style={{animation:"fadeIn 0.3s ease"}}>
      <div className="w-full flex items-center justify-between">
        <button onClick={onBack} className="px-3 py-1.5 rounded-lg text-sm font-semibold transition-all hover:translate-x-[-2px]" style={{background:"rgba(255,255,255,0.08)",color:"#d6d3d1",border:"1px solid rgba(255,255,255,0.08)"}}>‚Üê Back</button>
        <div className="text-center">
          <div className="text-lg font-bold" style={{color:"#fafaf9",letterSpacing:"-0.02em"}}>{opening.name}</div>
          <div style={{fontSize:12,color:"#a8a29e"}}>{opening.color === "white" ? "‚ôî" : "‚ôö"} {opening.eco}{branchName&&<span style={{color:"#fbbf24",marginLeft:6}}>‚Üí {branchName}</span>}</div>
        </div>
        <div style={{padding:"4px 10px",borderRadius:6,fontSize:12,fontWeight:700,background:bc.bg,color:bc.text,border:`1px solid ${bc.border}`}}>{boxLabels[srData.box]}</div>
      </div>
      <div className="w-full" style={{padding:"10px 14px",borderRadius:10,background:"rgba(180,130,40,0.1)",border:"1px solid rgba(180,130,40,0.2)",color:"#fcd34d",fontSize:13}}>üí° {currentTip}</div>
      {opening.branchAt!==undefined&&moveIndex>=opening.branchAt&&activeBranch===null&&status==="playing"&&(
        <div className="w-full" style={{padding:"10px 14px",borderRadius:10,background:"rgba(124,58,237,0.12)",border:"1px solid rgba(124,58,237,0.25)",color:"#c4b5fd",fontSize:13}}>üîÄ Branch! Choose: {opening.branches.map(b=>b.name).join(" or ")}</div>
      )}
      <div className="relative">
        <ChessBoard board={board} flipped={!isUserWhite} selected={selected} onSquareClick={handleSquareClick} lastMove={lastMove} wrongMove={wrongMove} correctSquare={correctSquare} correctFrom={correctFrom} correctSan={correctSan}/>
        {status==="complete"&&(
          <div className="absolute inset-0 flex flex-col items-center justify-center gap-3" style={{background:"rgba(12,10,9,0.88)",borderRadius:14,backdropFilter:"blur(8px)",animation:"fadeIn 0.3s ease",zIndex:30}}>
            <div style={{fontSize:48}}>{mistakes===0?"üéØ":mistakes<=2?"üëç":"üí™"}</div>
            <div style={{fontSize:22,fontWeight:800,color:"white"}}>{mistakes===0?"Perfect!":mistakes<=2?"Good job!":"Keep practicing!"}</div>
            <div style={{fontSize:14,color:"#a8a29e"}}>{mistakes} mistake{mistakes!==1?"s":""}</div>
            <div className="flex gap-2 mt-2">
              <button onClick={handleRestart} style={{padding:"8px 20px",borderRadius:10,background:"linear-gradient(135deg,#d97706,#b45309)",color:"white",fontWeight:600,fontSize:14,border:"none",cursor:"pointer"}}>Drill Again</button>
              <button onClick={onBack} style={{padding:"8px 20px",borderRadius:10,background:"rgba(255,255,255,0.1)",color:"white",fontWeight:600,fontSize:14,border:"none",cursor:"pointer"}}>Back</button>
            </div>
          </div>
        )}
      </div>
      <div className="w-full flex items-center justify-between gap-3">
        <div style={{flex:1,fontSize:13,color:"#d6d3d1",fontFamily:"'Courier New',monospace",background:"rgba(0,0,0,0.2)",borderRadius:8,padding:"8px 12px",minHeight:36,overflowX:"auto",whiteSpace:"nowrap"}}>
          {fmtH.length>0?fmtH.join("  "):<span style={{color:"#78716c",fontStyle:"italic"}}>Your move...</span>}
        </div>
        {status==="playing"&&isUserTurn(moveIndex)&&(
          <button onClick={hint} style={{padding:"6px 14px",borderRadius:8,background:"rgba(255,255,255,0.08)",color:"#a8a29e",fontSize:13,border:"1px solid rgba(255,255,255,0.06)",cursor:"pointer",flexShrink:0}}>
            {showHint?`Play ${opening.branchAt===moveIndex&&activeBranch===null?opening.branches.map(b=>b.continuation[0].san).join("/"):currentExpected?.san}`:"Hint üí°"}
          </button>
        )}
      </div>
    </div>
  );
};
const BlindDrillView = ({ sr, setSR, session, onBack }) => {
  const [opening,setOpening]=useState(null);const [board,setBoard]=useState(INIT_BOARD());const [moveIndex,setMoveIndex]=useState(0);
  const [selected,setSelected]=useState(null);const [lastMove,setLastMove]=useState(null);const [wrongMove,setWrongMove]=useState(null);
  const [correctSquare,setCorrectSquare]=useState(null);const [correctFrom,setCorrectFrom]=useState(null);const [correctSan,setCorrectSan]=useState(null);const [status,setStatus]=useState("playing");const [moveHistory,setMoveHistory]=useState([]);
  const [mistakes,setMistakes]=useState(0);const [showHint,setShowHint]=useState(false);const [revealed,setRevealed]=useState(false);
  const [roundCount,setRoundCount]=useState(0);const [roundResults,setRoundResults]=useState([]);
  const [plusMistakes,setPlusMistakes]=useState(false);const [activeBranch,setActiveBranch]=useState(null);
  const [mistakeTriggered,setMistakeTriggered]=useState(null);const [punishmentDone,setPunishmentDone]=useState(false);
  const [elapsed,setElapsed]=useState(0);const [finalTime,setFinalTime]=useState(null);
  const timerRef=useRef(null);const clockRef=useRef(null);const startTimeRef=useRef(null);
  const pickRandom=useCallback(()=>{
    const w=OPENINGS.map(o=>{const s=sr[o.id];return s?Math.max(1,6-s.box):5;});
    const total=w.reduce((a,b)=>a+b,0);let r=Math.random()*total;
    for(let i=0;i<OPENINGS.length;i++){r-=w[i];if(r<=0)return OPENINGS[i];}return OPENINGS[OPENINGS.length-1];
  },[sr]);
  const startRound=useCallback(()=>{
    const o=pickRandom();let branch=null;
    if(o.branchAt!==undefined)branch=Math.floor(Math.random()*o.branches.length);
    setOpening(o);setActiveBranch(branch);setBoard(INIT_BOARD());setMoveIndex(0);setSelected(null);setLastMove(null);
    setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);setStatus("playing");setMoveHistory([]);setMistakes(0);setShowHint(false);
    setRevealed(false);setMistakeTriggered(null);setPunishmentDone(false);setRoundCount(prev=>prev+1);
    setElapsed(0);setFinalTime(null);startTimeRef.current=Date.now();
    if(clockRef.current)clearInterval(clockRef.current);
    clockRef.current=setInterval(()=>{if(startTimeRef.current)setElapsed(Date.now()-startTimeRef.current);},100);
  },[pickRandom]);
  const repeatRound=useCallback(()=>{
    if(!opening)return;
    let branch=activeBranch;
    if(opening.branchAt!==undefined&&branch===null)branch=Math.floor(Math.random()*opening.branches.length);
    setActiveBranch(branch);setBoard(INIT_BOARD());setMoveIndex(0);setSelected(null);setLastMove(null);
    setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);setStatus("playing");setMoveHistory([]);setMistakes(0);setShowHint(false);
    setRevealed(false);setMistakeTriggered(null);setPunishmentDone(false);setRoundCount(prev=>prev+1);
    setElapsed(0);setFinalTime(null);startTimeRef.current=Date.now();
    if(clockRef.current)clearInterval(clockRef.current);
    clockRef.current=setInterval(()=>{if(startTimeRef.current)setElapsed(Date.now()-startTimeRef.current);},100);
  },[opening,activeBranch]);
  useEffect(()=>{startRound();return()=>{if(clockRef.current)clearInterval(clockRef.current);};},[]);
  const isUserWhite=opening?.color==="white";
  const activeMoves=useMemo(()=>opening?getActiveMoves(opening,activeBranch):[],[opening,activeBranch]);
  const isUserTurn=useCallback(idx=>{if(!opening)return false;return opening.color==="white"?idx%2===0:idx%2===1;},[opening]);
  useEffect(()=>{
    if(!opening||status!=="playing"||moveIndex>=activeMoves.length||punishmentDone)return;
    if(mistakeTriggered)return;
    if(!isUserTurn(moveIndex)){
      timerRef.current=setTimeout(()=>{
        if(plusMistakes&&opening.mistakes?.length>0){
          const applicable=opening.mistakes.filter(m=>m.atIndex===moveIndex);
          if(applicable.length>0&&Math.random()<0.2){
            const mk=applicable[Math.floor(Math.random()*applicable.length)];
            setBoard(prev=>applyMove(prev,mk.wrongMove.from,mk.wrongMove.to,mk.wrongMove.extra));
            setLastMove({from:sq(mk.wrongMove.from),to:sq(mk.wrongMove.to)});
            setMoveHistory(prev=>[...prev,mk.wrongMove.san]);
            setMoveIndex(prev=>prev+1);setMistakeTriggered({punishment:mk.punishment,hint:mk.hint});setSelected(null);return;
          }
        }
        const move=activeMoves[moveIndex];
        setBoard(prev=>applyMove(prev,move.from,move.to,move.extra));
        setLastMove({from:sq(move.from),to:sq(move.to)});setMoveHistory(prev=>[...prev,move.san]);
        setMoveIndex(prev=>prev+1);setSelected(null);setShowHint(false);
      },400);return()=>clearTimeout(timerRef.current);
    }
  },[moveIndex,status,board,opening,isUserTurn,activeMoves,plusMistakes,mistakeTriggered,punishmentDone]);
  useEffect(()=>{
    if(!opening)return;
    if((moveIndex>=activeMoves.length||punishmentDone)&&status==="playing"){
      if(clockRef.current){clearInterval(clockRef.current);clockRef.current=null;}
      const ft=startTimeRef.current?Date.now()-startTimeRef.current:0;setFinalTime(ft);setElapsed(ft);
      setStatus("complete");const perfect=mistakes===0;
      const userMoveCount=activeMoves.filter((_,i)=>opening.color==="white"?i%2===0:i%2===1).length;
      const targetMs=userMoveCount*3000;const underTarget=ft<=targetMs;
      setRoundResults(prev=>[...prev.slice(-19),{name:opening.name,perfect,punished:punishmentDone,time:ft,target:targetMs,fast:underTarget}]);
      setSR(prev=>{const s={...(prev[opening.id]||{box:1,correct:0,incorrect:0,lastDrilled:0,streak:0})};
        if(perfect){s.correct++;s.streak++;s.box=Math.min(5,s.box+1);}else{s.incorrect++;s.streak=0;s.box=Math.max(1,s.box-1);}
        s.lastDrilled=session;return{...prev,[opening.id]:s};});
    }
  },[moveIndex,opening,status,mistakes,session,setSR,activeMoves,punishmentDone]);
  const handleSquareClick=(r,c)=>{
    if(!opening||status!=="playing")return;
    if(punishmentDone)return;if(wrongMove){setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);}
    if(mistakeTriggered&&!punishmentDone){
      const pm=mistakeTriggered.punishment;const[pfr,pfc]=sq(pm.from),[ptr,ptc]=sq(pm.to);
      if(!selected){if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase())setSelected([r,c]);}return;}
      if(selected[0]===r&&selected[1]===c){setSelected(null);return;}
      if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase()){setSelected([r,c]);return;}}
      if(selected[0]===pfr&&selected[1]===pfc&&r===ptr&&c===ptc){
        setBoard(prev=>applyMove(prev,pm.from,pm.to,pm.extra));setLastMove({from:[pfr,pfc],to:[ptr,ptc]});
        setMoveHistory(prev=>[...prev,pm.san]);setPunishmentDone(true);setSelected(null);
      }else{setWrongMove([r,c]);setCorrectSquare([ptr,ptc]);setCorrectFrom([pfr,pfc]);setCorrectSan(pm.san);setMistakes(prev=>prev+1);setSelected(null);setTimeout(()=>{setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);},2000);}
      return;
    }
    if(!isUserTurn(moveIndex)||moveIndex>=activeMoves.length)return;
    const em=activeMoves[moveIndex];const[efr,efc]=sq(em.from),[etr,etc]=sq(em.to);
    if(!selected){if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase())setSelected([r,c]);}}
    else{
      if(selected[0]===r&&selected[1]===c){setSelected(null);return;}
      if(board[r][c]){const p=board[r][c];if(isUserWhite?p===p.toUpperCase():p===p.toLowerCase()){setSelected([r,c]);return;}}
      if(selected[0]===efr&&selected[1]===efc&&r===etr&&c===etc){
        setBoard(prev=>applyMove(prev,em.from,em.to,em.extra));setLastMove({from:[efr,efc],to:[etr,etc]});
        setMoveHistory(prev=>[...prev,em.san]);setMoveIndex(prev=>prev+1);setSelected(null);setShowHint(false);
      }else{setWrongMove([r,c]);setCorrectSquare([etr,etc]);setCorrectFrom([efr,efc]);setCorrectSan(em.san);setMistakes(prev=>prev+1);setSelected(null);setTimeout(()=>{setWrongMove(null);setCorrectSquare(null);setCorrectFrom(null);setCorrectSan(null);},2000);}
    }
  };
  const hint=()=>{setShowHint(true);setMistakes(prev=>prev+1);};
  const curExp=mistakeTriggered&&!punishmentDone?mistakeTriggered.punishment:(opening&&moveIndex<activeMoves.length&&isUserTurn(moveIndex)?activeMoves[moveIndex]:null);
  const fmtH=[];for(let i=0;i<moveHistory.length;i+=2)fmtH.push(`${Math.floor(i/2)+1}. ${moveHistory[i]}${moveHistory[i+1]?" "+moveHistory[i+1]:""}`);
  const recentPerfect=roundResults.filter(r=>r.perfect).length;
  const userMoveCount=opening?activeMoves.filter((_,i)=>opening.color==="white"?i%2===0:i%2===1).length:0;
  const targetMs=userMoveCount*3000;
  const displayTime=finalTime!==null?finalTime:elapsed;
  const timeSec=(displayTime/1000).toFixed(1);
  const targetSec=(targetMs/1000).toFixed(0);
  const timerPct=Math.min(100,(displayTime/targetMs)*100);
  const overTarget=displayTime>targetMs;
  if(!opening)return null;
  return(
    <div className="flex flex-col items-center gap-4 w-full max-w-xl mx-auto" style={{animation:"fadeIn 0.3s ease"}}>
      <div className="w-full flex items-center justify-between">
        <button onClick={onBack} style={{padding:"6px 14px",borderRadius:8,background:"rgba(255,255,255,0.08)",color:"#d6d3d1",fontSize:13,fontWeight:600,border:"1px solid rgba(255,255,255,0.06)",cursor:"pointer"}}>‚Üê Back</button>
        <div className="text-center">
          <div style={{fontSize:18,fontWeight:800,color:"#fafaf9",display:"flex",alignItems:"center",gap:8,justifyContent:"center"}}>
            <span style={{color:"#a78bfa"}}>üé≤</span> Blind Drill <span style={{fontSize:11,fontWeight:400,color:"#78716c",background:"rgba(255,255,255,0.05)",padding:"2px 8px",borderRadius:99}}>#{roundCount}</span>
          </div>
          <div style={{fontSize:12,color:"#a8a29e"}}>{status==="playing"&&!revealed?`${opening.color==="white"?"‚ôî":"‚ôö"} Identify the opening...`:revealed?opening.name:null}</div>
        </div>
        <div style={{fontSize:14,color:"#a8a29e",fontFamily:"'Courier New',monospace"}}>{recentPerfect}/{roundResults.length} üéØ</div>
      </div>
      <div className="w-full flex items-center justify-between px-1">
        <button onClick={()=>setPlusMistakes(!plusMistakes)} style={{
          display:"flex",alignItems:"center",gap:8,padding:"6px 14px",borderRadius:8,fontSize:13,fontWeight:600,cursor:"pointer",transition:"all 0.2s",
          background:plusMistakes?"rgba(220,38,38,0.15)":"rgba(255,255,255,0.04)",
          border:`1px solid ${plusMistakes?"rgba(239,68,68,0.3)":"rgba(255,255,255,0.08)"}`,
          color:plusMistakes?"#fca5a5":"#78716c",
        }}>{plusMistakes?"üí•":"‚óã"} Curveball Mode {plusMistakes?"ON":"OFF"}</button>
        {!revealed&&status==="playing"&&<button onClick={()=>setRevealed(true)} style={{fontSize:12,padding:"4px 10px",borderRadius:6,background:"rgba(124,58,237,0.15)",color:"#c4b5fd",border:"1px solid rgba(124,58,237,0.2)",cursor:"pointer"}}>Peek</button>}
      </div>
      {/* ‚îÄ‚îÄ Timer Bar ‚îÄ‚îÄ */}
      <div className="w-full" style={{padding:"8px 14px",borderRadius:10,background:"rgba(0,0,0,0.25)",border:`1px solid ${overTarget?"rgba(239,68,68,0.2)":"rgba(255,255,255,0.06)"}`}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <span style={{fontSize:11,color:"#78716c"}}>‚è±</span>
            <span style={{fontSize:15,fontWeight:700,fontFamily:"'Courier New',monospace",color:overTarget?"#f87171":timerPct>75?"#fde047":"#67e8f9",letterSpacing:"-0.02em"}}>{timeSec}s</span>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:6}}>
            <span style={{fontSize:11,color:"#78716c"}}>target</span>
            <span style={{fontSize:13,fontWeight:600,fontFamily:"'Courier New',monospace",color:"#a8a29e"}}>{targetSec}s</span>
            <span style={{fontSize:11,color:"#57534e"}}>({userMoveCount} moves √ó 3s)</span>
          </div>
        </div>
        <div style={{width:"100%",height:6,borderRadius:3,background:"rgba(255,255,255,0.06)",overflow:"hidden",position:"relative"}}>
          <div style={{
            height:"100%",borderRadius:3,transition:"width 0.1s linear",
            width:`${Math.min(timerPct,100)}%`,
            background:overTarget?"linear-gradient(90deg,#ef4444,#dc2626)":timerPct>75?"linear-gradient(90deg,#eab308,#ca8a04)":"linear-gradient(90deg,#06b6d4,#0891b2)",
          }}/>
          {/* Target marker line */}
          {timerPct<120&&<div style={{position:"absolute",top:-1,bottom:-1,left:"100%",width:2,background:"rgba(255,255,255,0.3)",borderRadius:1}}/>}
        </div>
      </div>
      {status==="playing"&&!revealed&&!punishmentDone&&<div className="w-full" style={{padding:"10px 14px",borderRadius:10,background:"rgba(124,58,237,0.08)",border:"1px solid rgba(124,58,237,0.15)",color:"#c4b5fd",fontSize:13}}>üîÆ What opening is this?</div>}
      {revealed&&status==="playing"&&!punishmentDone&&<div className="w-full" style={{padding:"10px 14px",borderRadius:10,background:"rgba(180,130,40,0.1)",border:"1px solid rgba(180,130,40,0.2)",color:"#fcd34d",fontSize:13}}>üí° {opening.name} ‚Äî {opening.tip}</div>}
      <div className="relative">
        <ChessBoard board={board} flipped={!isUserWhite} selected={selected} onSquareClick={handleSquareClick} lastMove={lastMove} wrongMove={wrongMove} correctSquare={correctSquare} correctFrom={correctFrom} correctSan={correctSan}/>
        {status==="complete"&&(
          <div className="absolute inset-0 flex flex-col items-center justify-center gap-2" style={{background:"rgba(12,10,9,0.88)",borderRadius:14,backdropFilter:"blur(8px)",animation:"fadeIn 0.3s ease",zIndex:30}}>
            <div style={{fontSize:48}}>{mistakes===0?"üéØ":mistakes<=2?"üëç":"üí™"}</div>
            <div style={{fontSize:18,fontWeight:800,color:"white"}}>{opening.name}</div>
            <div style={{fontSize:12,color:"#a8a29e"}}>{opening.eco} ‚Ä¢ {opening.color}{punishmentDone&&<span style={{color:"#86efac",marginLeft:6}}>‚Ä¢ punished!</span>}</div>
            <div style={{fontSize:14,color:"#d6d3d1"}}>{mistakes===0?"Perfect!":`${mistakes} mistake${mistakes!==1?"s":""}`}</div>
            {finalTime!==null&&(
              <div style={{display:"flex",alignItems:"center",gap:6,marginTop:2}}>
                <span style={{fontSize:13,fontWeight:700,fontFamily:"'Courier New',monospace",color:finalTime<=targetMs?"#4ade80":"#f87171"}}>{(finalTime/1000).toFixed(1)}s</span>
                <span style={{fontSize:11,color:"#78716c"}}>/ {(targetMs/1000).toFixed(0)}s target</span>
                {finalTime<=targetMs&&<span style={{fontSize:12}}>‚ö°</span>}
              </div>
            )}
            <div style={{display:"flex",gap:10,marginTop:12,flexWrap:"wrap",justifyContent:"center"}}>
              {(mistakes>0||finalTime>targetMs)&&<button onClick={repeatRound} style={{padding:"10px 24px",borderRadius:12,fontWeight:700,fontSize:14,background:"linear-gradient(135deg,#d97706,#b45309)",color:"white",border:"none",cursor:"pointer",boxShadow:"0 4px 15px rgba(217,119,6,0.3)"}}>üîÅ Repeat Drill</button>}
              <button onClick={startRound} style={{padding:"10px 24px",borderRadius:12,fontWeight:700,fontSize:14,background:"linear-gradient(135deg,#7c3aed,#5b21b6)",color:"white",border:"none",cursor:"pointer",boxShadow:"0 4px 15px rgba(124,58,237,0.3)"}}>‚ö° Next ‚Äî Rapid Fire</button>
            </div>
          </div>
        )}
      </div>
      <div className="w-full flex items-center justify-between gap-3">
        <div style={{flex:1,fontSize:13,color:"#d6d3d1",fontFamily:"'Courier New',monospace",background:"rgba(0,0,0,0.2)",borderRadius:8,padding:"8px 12px",minHeight:36,overflowX:"auto",whiteSpace:"nowrap"}}>
          {fmtH.length>0?fmtH.join("  "):<span style={{color:"#78716c",fontStyle:"italic"}}>{isUserTurn(0)?"Your move...":"Watching..."}</span>}
        </div>
        {status==="playing"&&(isUserTurn(moveIndex)||(mistakeTriggered&&!punishmentDone))&&(
          <button onClick={hint} style={{padding:"6px 14px",borderRadius:8,background:"rgba(255,255,255,0.08)",color:"#a8a29e",fontSize:13,border:"1px solid rgba(255,255,255,0.06)",cursor:"pointer",flexShrink:0}}>{showHint?`Play ${curExp?.san}`:"Hint üí°"}</button>
        )}
      </div>
      {roundResults.length>0&&(
        <div className="w-full flex items-center gap-1.5 flex-wrap">
          <span style={{fontSize:11,color:"#78716c",marginRight:4}}>History:</span>
          {roundResults.map((r,i)=>(
            <div key={i} style={{fontSize:11,padding:"2px 8px",borderRadius:99,
              background:r.perfect?"rgba(34,197,94,0.15)":"rgba(239,68,68,0.1)",
              border:`1px solid ${r.perfect?"rgba(34,197,94,0.25)":"rgba(239,68,68,0.15)"}`,
              color:r.perfect?"#86efac":"#fca5a5",
            }} title={`${r.name}${r.time?` ‚Äî ${(r.time/1000).toFixed(1)}s`:""}${r.punished?" (punished)":""}`}>{r.fast&&r.perfect?"‚ö°":r.perfect?"‚úì":"‚úï"} {r.name.split(":")[0].split("vs ").pop().substring(0,8)}{r.time?` ${(r.time/1000).toFixed(0)}s`:""}</div>
          ))}
        </div>
      )}
    </div>
  );
};
const ChessComImport = ({ onBack }) => {
  const [username,setUsername]=useState("zachgoldfine");const [loading,setLoading]=useState(false);
  const [results,setResults]=useState(null);const [error,setError]=useState(null);
  const classify=(moves,zc)=>{
    if(moves.length<2)return"Unknown";const[w,b]=[moves[0],moves[1]];
    if(zc==="white"){if(w==="e4"){if(b==="e5"){if(moves[2]==="Nf3"){if(moves[3]==="Nc6"&&moves[4]==="d4")return"Scotch ‚úÖ";if(moves[3]==="Nf6")return"Petrov"+(moves[4]==="Nxe5"?" ‚úÖ":" ‚ö†Ô∏è");if(moves[3]==="d6")return"Philidor ‚úÖ";}return`e4 e5 ${moves[2]}`;}if(b==="c5")return"Sicilian"+(moves[2]==="c3"?" (Alapin) ‚úÖ":"");if(b==="e6")return"French ‚úÖ";if(b==="c6")return"Caro-Kann ‚úÖ";if(b==="d5")return"Scandinavian ‚úÖ";if(b==="d6")return"Pirc ‚úÖ";if(b==="g6")return"Modern ‚úÖ";return`e4 ${b}`;}return`${w}...`;}
    else{if(w==="e4"&&b==="e5"){if(moves[2]==="Nf3"&&moves[3]==="Nc6"){if(moves[4]==="Bc4")return"Italian ‚úÖ";if(moves[4]==="Bb5")return"Ruy Lopez ‚úÖ";if(moves[4]==="d4")return"Scotch";}if(moves[2]==="Bc4")return"Bishop's Opening ‚úÖ";if(moves[2]==="Nc3")return"Vienna ‚úÖ";if(moves[2]==="f4")return"King's Gambit ‚úÖ";return`e4 e5 ${moves[2]}`;}if(w==="d4"){if(b==="d5"){if(moves[2]==="c4")return"QGD ‚úÖ";if(moves[2]==="Bf4"||(moves[2]==="Nf3"&&moves[4]==="Bf4"))return"London ‚úÖ";return`d4 d5 ${moves[2]}`;}return`d4 ${b}`;}if(w==="c4")return"English ‚úÖ";return`${w}...`;}
  };
  const fetchGames=async()=>{
    setLoading(true);setError(null);setResults(null);
    try{const now=new Date(),months=[];for(let i=0;i<2;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push(`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}`);}
      let all=[];for(const m of months){try{const r=await fetch(`https://api.chess.com/pub/player/${username.toLowerCase()}/games/${m}`);if(r.ok){const d=await r.json();if(d.games)all=all.concat(d.games);}}catch(e){}}
      if(!all.length){setError("No games found.");setLoading(false);return;}
      const parsed=[];for(const g of all){if(!g.pgn||!["blitz","rapid"].includes(g.time_class))continue;const isW=g.white?.username?.toLowerCase()===username.toLowerCase();const isB=g.black?.username?.toLowerCase()===username.toLowerCase();if(!isW&&!isB)continue;const zc=isW?"white":"black";const mc=g.pgn.replace(/\{[^}]*\}/g,"").replace(/\d+\.\.\./g,"");const mm=[...mc.matchAll(/(\d+)\.\s+(\S+)\s+(\S+)?/g)];const flat=[];for(const m of mm.slice(0,8)){flat.push(m[2]);if(m[3]&&!["1-0","0-1","1/2-1/2"].includes(m[3]))flat.push(m[3]);}parsed.push({zc,moves:flat,cls:classify(flat,zc),result:g[zc]?.result||""});}
      const byC={};parsed.forEach(p=>{if(!byC[p.cls])byC[p.cls]={count:0,wins:0,losses:0,draws:0,color:p.zc};byC[p.cls].count++;if(p.result==="win")byC[p.cls].wins++;else if(["loss","checkmated","resigned","timeout","abandoned"].includes(p.result))byC[p.cls].losses++;else byC[p.cls].draws++;});
      setResults({total:parsed.length,openings:Object.entries(byC).sort((a,b)=>b[1].count-a[1].count)});
    }catch(e){setError("Error: "+e.message);}setLoading(false);
  };
  return(
    <div className="flex flex-col gap-4 w-full max-w-xl mx-auto" style={{animation:"fadeIn 0.3s ease"}}>
      <div className="flex items-center justify-between">
        <button onClick={onBack} style={{padding:"6px 14px",borderRadius:8,background:"rgba(255,255,255,0.08)",color:"#d6d3d1",fontSize:13,fontWeight:600,border:"1px solid rgba(255,255,255,0.06)",cursor:"pointer"}}>‚Üê Back</button>
        <div style={{fontSize:18,fontWeight:800,color:"#fafaf9"}}>üì• Chess.com Import</div><div style={{width:60}}/>
      </div>
      <div style={{padding:16,borderRadius:12,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)"}}>
        <div style={{fontSize:13,color:"#a8a29e",marginBottom:12}}>Fetch recent blitz &amp; rapid games and see which openings you face vs. the trainer.</div>
        <div className="flex gap-2">
          <input value={username} onChange={e=>setUsername(e.target.value)} placeholder="Chess.com username"
            style={{flex:1,padding:"8px 12px",borderRadius:8,background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.08)",color:"#e7e5e4",fontSize:13,outline:"none"}}/>
          <button onClick={fetchGames} disabled={loading} style={{padding:"8px 16px",borderRadius:8,background:loading?"#555":"linear-gradient(135deg,#d97706,#b45309)",color:"white",fontWeight:600,fontSize:13,border:"none",cursor:loading?"wait":"pointer",flexShrink:0}}>{loading?"Loading...":"Fetch"}</button>
        </div>
        {error&&<div style={{marginTop:8,color:"#f87171",fontSize:13}}>{error}</div>}
      </div>
      {results&&(
        <div className="flex flex-col gap-2">
          <div style={{fontSize:13,color:"#a8a29e"}}><strong style={{color:"#fafaf9"}}>{results.total}</strong> games analyzed:</div>
          {results.openings.map(([name,data],i)=>{
            const ok=name.includes("‚úÖ"),warn=name.includes("‚ö†Ô∏è");
            const wr=data.count>0?Math.round(data.wins/data.count*100):0;
            return(<div key={i} style={{padding:"8px 12px",borderRadius:8,fontSize:13,background:ok?"rgba(34,197,94,0.08)":warn?"rgba(234,179,8,0.08)":"rgba(255,255,255,0.03)",border:`1px solid ${ok?"rgba(34,197,94,0.15)":warn?"rgba(234,179,8,0.15)":"rgba(255,255,255,0.04)"}`,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div className="flex items-center gap-2"><span style={{fontSize:11,padding:"2px 6px",borderRadius:4,background:data.color==="white"?"#e7e5e4":"#44403c",color:data.color==="white"?"#1c1917":"#e7e5e4"}}>{data.color==="white"?"‚ôî":"‚ôö"}</span><span style={{color:ok?"#86efac":warn?"#fde047":"#d6d3d1"}}>{name.replace(/ ‚úÖ| ‚ö†Ô∏è/g,"")}</span></div>
              <div className="flex items-center gap-3" style={{fontSize:11,color:"#78716c"}}><span>{data.count}g</span><span style={{color:wr>=50?"#4ade80":"#f87171"}}>{wr}%</span></div>
            </div>);
          })}
        </div>
      )}
    </div>
  );
};
function App() {
  const [sr,setSR]=useState(initSR);const [session,setSession]=useState(1);const [view,setView]=useState("dashboard");
  const [currentOpening,setCurrentOpening]=useState(null);const [filter,setFilter]=useState("all");
  useEffect(()=>{setSR(prev=>{const n={...prev};OPENINGS.forEach(o=>{if(!n[o.id])n[o.id]={box:1,correct:0,incorrect:0,lastDrilled:0,streak:0};});return n;});},[]);
  const startDrill=o=>{setCurrentOpening(o);setView("drill");};
  const smartDrill=()=>{const n=getNextDrill(sr,session);if(n)startDrill(n);};
  const handleBack=()=>{setView("dashboard");setSession(prev=>prev+1);};
  const totalC=Object.values(sr).reduce((s,v)=>s+(v.correct||0),0);
  const totalI=Object.values(sr).reduce((s,v)=>s+(v.incorrect||0),0);
  const avgBox=(Object.values(sr).reduce((s,v)=>s+(v.box||1),0)/OPENINGS.length).toFixed(1);
  const solidCount=Object.values(sr).filter(v=>(v.box||1)>=4).length;
  const filtered=filter==="all"?OPENINGS:OPENINGS.filter(o=>o.color===filter);
  if(view==="import")return(<div style={{minHeight:"100vh",padding:16,background:"linear-gradient(145deg, #0f0d0a 0%, #1a1510 50%, #0f0d0a 100%)"}}><ChessComImport onBack={handleBack}/></div>);
  if(view==="blind")return(<div style={{minHeight:"100vh",padding:16,display:"flex",justifyContent:"center",background:"linear-gradient(145deg, #0f0d0a 0%, #16101e 50%, #0f0d0a 100%)"}}><BlindDrillView sr={sr} setSR={setSR} session={session} onBack={handleBack}/></div>);
  if(view==="drill"&&currentOpening)return(<div style={{minHeight:"100vh",padding:16,display:"flex",justifyContent:"center",background:"linear-gradient(145deg, #0f0d0a 0%, #1a1510 50%, #0f0d0a 100%)"}}><DrillView opening={currentOpening} sr={sr} setSR={setSR} session={session} onBack={handleBack}/></div>);
  const Row=({o})=>{const s=sr[o.id]||{box:1,streak:0};const bc=boxColors[s.box];return(
    <button onClick={()=>startDrill(o)} style={{
      width:"100%",textAlign:"left",padding:"10px 14px",borderRadius:10,border:`1px solid ${bc.border}30`,
      background:`${bc.bg}30`,cursor:"pointer",transition:"all 0.15s",display:"block",
    }}
    onMouseOver={e=>{e.currentTarget.style.transform="translateX(2px)";e.currentTarget.style.borderColor=bc.border+"60";}}
    onMouseOut={e=>{e.currentTarget.style.transform="none";e.currentTarget.style.borderColor=bc.border+"30";}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div><span style={{fontWeight:600,color:"#fafaf9",fontSize:14}}>{o.name}</span><span style={{color:"#78716c",fontSize:12,marginLeft:8}}>{o.eco}</span>{o.branchAt!==undefined&&<span style={{color:"#a78bfa",fontSize:12,marginLeft:4}}>üîÄ</span>}</div>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          {s.streak>=3&&<span style={{fontSize:12}}>üî•{s.streak}</span>}
          <div style={{width:8,height:8,borderRadius:4,background:bc.dot}}/>
          <span style={{fontSize:12,fontWeight:600,color:bc.text}}>{boxLabels[s.box]}</span>
        </div>
      </div>
      <div style={{fontSize:11,color:"#78716c",marginTop:2}}>{o.category} ‚Ä¢ {o.branchAt?`${o.moves.length}+branch`:o.moves.length} moves{o.mistakes?.length>0?" ‚Ä¢ üí•":""}</div>
    </button>
  );};
  return(
    <div style={{minHeight:"100vh",padding:16,background:"linear-gradient(145deg, #0f0d0a 0%, #1a1510 50%, #0f0d0a 100%)"}}>
      <style>{`@keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }`}</style>
      <div className="max-w-xl mx-auto" style={{animation:"fadeIn 0.4s ease"}}>
        <div style={{textAlign:"center",marginBottom:28}}>
          <h1 style={{fontSize:28,fontWeight:800,color:"#fafaf9",letterSpacing:"-0.03em",fontFamily:"Georgia,serif",margin:0}}>‚ôî Opening Trainer</h1>
          <p style={{color:"#78716c",fontSize:13,margin:"6px 0 0"}}>Deliberate practice ¬∑ Spaced repetition ¬∑ 5‚Äëmin blitz ready</p>
        </div>
        {/* Stats */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8,marginBottom:20}}>
          {[{l:"Drilled",v:totalC+totalI,i:"üìä"},{l:"Accuracy",v:totalC+totalI>0?Math.round(totalC/(totalC+totalI)*100)+"%":"‚Äî",i:"üéØ"},{l:"Avg Box",v:avgBox,i:"üìà"},{l:"Solid+",v:`${solidCount}/${OPENINGS.length}`,i:"‚≠ê"}].map(({l,v,i})=>(
            <div key={l} style={{background:"rgba(255,255,255,0.03)",borderRadius:10,padding:"10px 8px",textAlign:"center",border:"1px solid rgba(255,255,255,0.04)"}}>
              <div style={{fontSize:18,fontWeight:700,color:"#fafaf9"}}>{v}</div>
              <div style={{fontSize:11,color:"#78716c"}}>{i} {l}</div>
            </div>
          ))}
        </div>
        {/* Action Buttons */}
        <button onClick={smartDrill} style={{width:"100%",marginBottom:10,padding:"14px 0",borderRadius:12,fontWeight:700,fontSize:17,background:"linear-gradient(135deg,#d97706 0%,#92400e 100%)",color:"white",border:"none",cursor:"pointer",boxShadow:"0 4px 20px rgba(217,119,6,0.25)",letterSpacing:"-0.01em"}}>‚ö° Smart Drill</button>
        <button onClick={()=>setView("blind")} style={{width:"100%",marginBottom:10,padding:"14px 0",borderRadius:12,fontWeight:700,fontSize:17,background:"linear-gradient(135deg,#7c3aed 0%,#4c1d95 100%)",color:"white",border:"none",cursor:"pointer",boxShadow:"0 4px 20px rgba(124,58,237,0.25)",letterSpacing:"-0.01em"}}>üé≤ Blind Drill ‚Äî Rapid Fire</button>
        <button onClick={()=>setView("import")} style={{width:"100%",marginBottom:20,padding:"10px 0",borderRadius:12,fontWeight:500,fontSize:13,background:"rgba(255,255,255,0.04)",color:"#a8a29e",border:"1px solid rgba(255,255,255,0.06)",cursor:"pointer"}}>üì• Import from Chess.com</button>
        {/* Filter */}
        <div style={{display:"flex",gap:6,marginBottom:16}}>
          {["all","white","black"].map(f=>(
            <button key={f} onClick={()=>setFilter(f)} style={{
              padding:"6px 14px",borderRadius:8,fontSize:13,fontWeight:500,cursor:"pointer",transition:"all 0.15s",
              background:filter===f?"rgba(217,119,6,0.2)":"rgba(255,255,255,0.03)",
              color:filter===f?"#fcd34d":"#78716c",
              border:`1px solid ${filter===f?"rgba(217,119,6,0.3)":"transparent"}`,
            }}>{f==="all"?"All Lines":f==="white"?"‚ôî White":"‚ôö Black"}</button>
          ))}
        </div>
        {/* Opening Lists */}
        {filtered.filter(o=>o.color==="white").length>0&&(filter==="all"||filter==="white")&&(
          <div style={{marginBottom:16}}>
            {filter==="all"&&<div style={{fontSize:11,fontWeight:700,color:"#57534e",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:8,paddingLeft:4}}>White Repertoire</div>}
            <div style={{display:"flex",flexDirection:"column",gap:6}}>{filtered.filter(o=>o.color==="white").map(o=><Row key={o.id} o={o}/>)}</div>
          </div>
        )}
        {filtered.filter(o=>o.color==="black").length>0&&(filter==="all"||filter==="black")&&(
          <div style={{marginBottom:16}}>
            {filter==="all"&&<div style={{fontSize:11,fontWeight:700,color:"#57534e",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:8,paddingLeft:4}}>Black Repertoire</div>}
            <div style={{display:"flex",flexDirection:"column",gap:6}}>{filtered.filter(o=>o.color==="black").map(o=><Row key={o.id} o={o}/>)}</div>
          </div>
        )}
        {/* How It Works */}
        <div style={{marginTop:24,padding:16,borderRadius:12,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.04)",fontSize:13,color:"#78716c"}}>
          <div style={{fontWeight:700,color:"#a8a29e",marginBottom:8}}>How This Works</div>
          <p style={{margin:"0 0 8px"}}><span style={{color:"#d6d3d1"}}>Leitner spaced repetition</span> ‚Äî 5 mastery boxes. Perfect runs promote, mistakes demote.</p>
          <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:8}}>
            {[1,2,3,4,5].map(b=><span key={b} style={{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:4,fontSize:11,background:boxColors[b].bg+"50",color:boxColors[b].text,border:`1px solid ${boxColors[b].border}30`}}><span style={{width:6,height:6,borderRadius:3,background:boxColors[b].dot}}/>{boxLabels[b]}</span>)}
          </div>
          <p style={{margin:"0 0 4px"}}><span style={{color:"#d6d3d1"}}>üé≤ Blind</span> ‚Äî random color, hidden name. <span style={{color:"#d6d3d1"}}>üí• Curveball Mode</span> ‚Äî opponent blunders, you punish.</p>
          <p style={{margin:0}}><span style={{color:"#d6d3d1"}}>üîÄ Branching</span> ‚Äî Scotch Nxc6: choose Schmidt (e5) or Mieses (Bd3) at the branch.</p>
        </div>
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>

